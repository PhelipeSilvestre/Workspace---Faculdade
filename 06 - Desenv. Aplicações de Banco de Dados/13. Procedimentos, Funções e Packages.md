**Procedimentos, Funções e Packages**

PROCEDIMENTOS ARMAZENADOS (STORED PROCEDURES)

Um procedimento armazenado, também conhecido como stored procedure, é um bloco PL/SQL identificado, reutilizável, armazenado como um objeto no banco de dados. Diferentemente dos blocos anônimos, um procedimento pode ter parâmetros de entrada, saída ou entrada/saída. Sua forma geral é:

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/837c1d08-0953-4f77-870c-7ed3d6b7b7bf)


O comando CREATE PROCEDURE cria a stored procedure. Após o nome, há uma relação de parâmetros entre parênteses. Se não houver parâmetros declarados, os parênteses devem ser omitidos.

Cada parâmetro declarado pode ser de entrada (IN), de saída (OUT) ou de entrada e saída (IN OUT). Se não for especificado, o compilador assume como parâmetro de entrada (IN). A execução da procedure termina quando é encontrado o comando RETURN ou o END do bloco principal. O exemplo a seguir cria a stored procedure fatorial_proc, que retorna o fatorial do número inteiro n.

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/89b9eccc-21d0-485b-8725-efba5cbfc862)


Na procedure fatorial_proc, foram declarados 2 parâmetros, um de entrada, n, e outro de saída, fatorial, que retorna o valor calculado para o bloco que chamou a procedure. O resultado, após a execução do bloco anônimo, é mostrado a seguir.

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/747489fc-7e5c-4396-81a5-6aae8c107b3a)


No exemplo a seguir, a procedure swap troca o conteúdo de duas variáveis do tipo VARCHAR2.  Ambos os parâmetros são do tipo IN OUT, fornecendo os valores para a procedure e retornado o resultado. Observe que não é necessário definir o tamanho do tipo VARCHAR2 para os parâmetros a e b (na realidade, não é permitido). Isto vale para todos os tipos em que é possível definir o tamanho.

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/c99b4872-aae0-4a5a-9084-d48e3e046eb3)


O resultado, após a execução do bloco anônimo, é mostrado a seguir.​

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/7ca443f1-93a2-4daa-8006-5e83d6c9b0e9)


​Deve-se executar o bloco de criação da procedure antes de qualquer referência a ela para que seja armazenada no banco de dados e passe a “existir”. Após sua criação, a procedure pode ser visualizada no explorador de objetos do SQL Developer:

Figura 1 – Procedures

![1679499947575-niAuBJHDL9](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/562b02f0-6a38-42d7-aed3-b6d27e6cdef9)

A alteração de uma procedure é simples. Ao clicar sobre o seu nome, no explorador de objetos, uma janela de edição é aberta. Basta fazer as alterações e clicar em Compile que as alterações são verificadas e, não havendo erros, a nova versão é armazenada. Na figura a seguir é mostrada a janela de edição do SQL Developer com a indicação do comando Compile.

![1679500002696-SjcUWumExt](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/3559e3d6-af1e-460a-a7ee-a273ffac877f)

Pode-se remover uma procedure de duas formas: através do comando DROP PROCEDURE nome ou no explorador de objetos, clicando com o botão direito do mouse sobre a procedure e selecionando DROP.


Os parâmetros declarados na definição da procedure são chamados de parâmetros formais, enquanto aqueles utilizados na chamada da procedure são chamados de parâmetros atuais. No momento de chamada de uma procedure e antes de sua execução, os parâmetros atuais devem ser mapeados nos parâmetros formais.


Na chamada de uma procedure, os parâmetros atuais podem ser associados aos formais pela posição (referência posicional) ou associando-os explicitamente (referência por nome)


Na referência posicional, a associação é feita pela ordem dos parâmetros atuais na chamada. Nesta forma, a quantidade e os tipos dos parâmetros atuais devem ser iguais aos dos parâmetros formais. Esta é a forma utilizada nos exemplos anteriores.

Na referência por nome, a associação é feita utilizando-se a notação parâmetro_formal => parâmetro_atual. A ordem e quantidade de parâmetros atuais não precisam ser iguais às dos formais. Deve-se tomar cuidado, porém, para que sejam atribuídos valores padrão aos parâmetros não obrigatórios. Além disto, não é permitido referências por nome antes de referências posicionais. No exemplo a seguir, o bloco anônimo chama a procedure fatorial utilizando as duas formas de passagem de parâmetros.

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/b91952a2-20c3-469c-9743-0d733a069592)


Uma procedure pode chamar outras procedures e até a si própria. Nesta última situação, a procedure é dita recursiva. Deve-se tomar muito cuidado com procedures recursivas para que elas não fiquem se chamando indefinidamente. Toda procedure recursiva deve ter uma condição de saída.


Considere o fatorial de um número n.  Pela definição “tradicional”, n! = n ∙ (n – 1) ∙ (n – 2) ∙ … ∙ 2 ∙ 1. Pode-se definir o fatorial de forma recursiva: n! = n ∙ (n – 1)!. O exemplo a seguir implementa recursivamente a função fatorial_proc_rec.

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/2530b4bd-4e32-40d4-b8af-921253eb3ab6)


O resultado, após a execução do bloco anônimo, é mostrado a seguir.​

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/cce9f986-9c70-4843-8244-9ff264b51616)






**FUNÇÕES ARMAZENADAS OU DEFINIDAS PELO USUÁRIO (STORED FUNCTIONS)*

Uma função definida pelo usuário é muito similar a uma procedure exceto pelo fato de que a função retorna um valor. Sua forma geral é:

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/922f7c8d-58df-4020-b043-3d2403a76644)


A declaração de parâmetros e as seções obrigatórias e opcionais são idênticas às de uma procedure. O tipo_retorno define o tipo do valor retornado e pode ser qualquer tipo válido em PL/SQL. O comando RETURN deve ser utilizado para encerrar uma função, retornando o resultado ao chamador. Um erro ocorre se a execução chegar ao END do bloco principal.

O valor retornado pela função deve ser compatível com o tipo declarado. O compilador PL/SQL faz automaticamente a conversão de tipos, quando possível. Por exemplo, um valor FLOAT retornado por uma função com tipo declarado de retorno NUMBER é automaticamente convertido. Já o retorno de um valor VARCHAR2 por esta mesma função causará erro.

Como nas procedures, os parâmetros podem ser passados por posição, por nome ou combinando as duas formas. O exemplo a seguir implementa a procedure fatorial_func através de uma função.

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/e5e67d4a-4bc5-4e7f-b55f-7c7d4f42cfac)

O resultado, após a execução do bloco anônimo, é mostrado a seguir.​

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/c9bd7ab2-2018-4a27-af56-0c52d2b15fe8)

​Assim como ocorre com as procedures, as funções também podem ser recursivas. O exemplo a seguir apresenta a função fatorial_func_rec, que calcula o fatorial de um número inteiro, implementada através de uma função recursiva.

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/0f2c8384-61b2-41bc-9579-45175332c97f)

O resultado, após a execução do bloco anônimo, é mostrado a seguir.​

![image](https://github.com/PhelipeSilvestre/Workspace---Faculdade/assets/99892687/388a839e-7a5a-43d0-9be5-1bf2f05c86b6)







































